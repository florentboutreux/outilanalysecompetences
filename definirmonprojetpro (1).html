<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartographie des Comp√©tences - France Travail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Importation de PDF.js pour la lecture locale des CV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuration du worker PDF.js - Indispensable pour la performance et stabilit√©
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animation pour le contenu de la modale */
        .modal-enter { animation: modalSlideIn 0.3s ease-out forwards; }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800 relative">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10">
            <div class="inline-block p-3 rounded-full bg-blue-100 mb-4">
                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900 mb-2">Cartographie des Comp√©tences</h1>
            <p class="text-lg text-blue-600">Assistant d'analyse & Formation</p>
        </header>

        <!-- Formulaire de Saisie -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl border border-blue-100 mb-8">
            <div class="space-y-6">
                <!-- M√©tier Recherch√© -->
                <div>
                    <label for="targetJob" class="block text-lg font-semibold text-gray-700 mb-2">
                        1. M√©tier vis√© 
                    </label>
                    <textarea id="targetJob" rows="1" placeholder="Ex: Assistant Administratif, Plombier, D√©veloppeur..."
                        class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-inner resize-none"></textarea>
                </div>

                <!-- M√©tiers Ant√©rieurs avec Upload CV -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label for="pastJobs" class="block text-lg font-semibold text-gray-700">
                            2. Exp√©riences pass√©es
                        </label>
                        
                        <!-- Input File cach√© et Bouton stylis√© -->
                        <input type="file" id="cvInput" accept=".pdf" class="hidden" onchange="handleCvUpload(this)">
                        <button onclick="document.getElementById('cvInput').click()" 
                            class="text-sm bg-blue-50 text-blue-700 hover:bg-blue-100 px-3 py-1.5 rounded-md border border-blue-200 transition flex items-center gap-2 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            Importer un CV (PDF)
                        </button>
                    </div>
                    
                    <div id="cvLoading" class="hidden text-sm text-blue-600 mb-2 flex items-center bg-blue-50 p-2 rounded">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span>Analyse du fichier en cours...</span>
                    </div>

                    <textarea id="pastJobs" rows="8" placeholder="Saisissez vos exp√©riences ou importez votre CV pour remplir ce champ automatiquement..."
                        class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-inner resize-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1 text-right">Le contenu du CV sera ajout√© et nettoy√© ci-dessus.</p>
                </div>

                <!-- Bouton d'Analyse -->
                <div class="text-center pt-2">
                    <button id="analyzeButton" onclick="startAnalysis()"
                        class="w-full md:w-2/3 py-4 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-blue-700 active:bg-blue-800 transition transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center mx-auto">
                        <span id="btnText">Lancer l'Analyse des Comp√©tences</span>
                        <svg id="btnSpinner" class="hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p id="errorMessage" class="hidden mt-4 text-red-600 font-medium bg-red-50 p-3 rounded-lg border border-red-200"></p>
                </div>
            </div>
        </div>

        <!-- Zone de R√©sultats -->
        <div id="resultsArea" class="hidden fade-in">
            <!-- Les r√©sultats seront inject√©s ici par JS -->
        </div>

        <!-- Section "Pour aller plus loin" (Initialement masqu√©e) -->
        <div id="furtherActions" class="hidden max-w-5xl mx-auto mt-8 mb-12 fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-600 w-8 h-8 rounded-full text-white flex items-center justify-center text-sm mr-3">3</span>
                Pour aller plus loin
            </h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Bouton Suggestions CV -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-indigo-100 flex flex-col">
                    <h4 class="font-bold text-lg text-indigo-900 mb-2">Optimisation du CV</h4>
                    <p class="text-gray-600 text-sm mb-4 flex-grow">Obtenez des suggestions concr√®tes pour adapter le CV actuel au poste vis√© (mots-cl√©s, mise en avant).</p>
                    <button id="btnCvAdvice" onclick="getAdvice('cv')" disabled
                        class="w-full py-3 bg-indigo-50 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-100 transition border border-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400">
                        Am√©liorer mon CV
                        <span id="cvBadge" class="block text-xs font-normal mt-1">(N√©cessite l'import d'un CV)</span>
                    </button>
                </div>

                <!-- Bouton Arguments Entretien -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-teal-100 flex flex-col">
                    <h4 class="font-bold text-lg text-teal-900 mb-2">Pr√©paration √† l'entretien</h4>
                    <p class="text-gray-600 text-sm mb-4 flex-grow">G√©n√©rez les arguments cl√©s pour convaincre le recruteur que votre profil correspond au poste.</p>
                    <button onclick="getAdvice('interview')"
                        class="w-full py-3 bg-teal-50 text-teal-600 font-semibold rounded-lg hover:bg-teal-100 transition border border-teal-200">
                        G√©n√©rer mes Arguments
                    </button>
                </div>
            </div>

            <!-- Zone d'affichage des conseils suppl√©mentaires (Inline) -->
            <div id="extraContentArea" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                <div id="extraContentSpinner" class="hidden flex justify-center py-4">
                    <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
                <div id="extraContentText" class="prose max-w-none text-gray-700"></div>
            </div>
        </div>

    </div>

    <!-- MODALE DE ZOOM (DETAIL) -->
    <div id="zoomModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Fond sombre -->
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeZoom()"></div>

            <!-- Contenu de la modale -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="relative inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full modal-enter">
                
                <!-- En-t√™te Modale -->
                <div id="zoomHeader" class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-900" id="modal-title">D√©tails</h3>
                    <button type="button" onclick="closeZoom()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Corps Modale -->
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    <!-- Spinner de chargement Zoom -->
                    <div id="zoomSpinner" class="flex flex-col items-center justify-center py-10">
                        <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="text-gray-500">G√©n√©ration des d√©tails approfondis en cours...</p>
                    </div>
                    
                    <!-- Contenu texte Zoom -->
                    <div id="zoomContent" class="prose max-w-none text-gray-700 hidden">
                        <!-- Inject√© par JS -->
                    </div>
                </div>

                <!-- Pied de page Modale -->
                <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeZoom()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Logique -->
    <script>
        const API_KEY = ""; // La cl√© est g√©r√©e par l'environnement
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        // Marqueur interne pour d√©tecter l'import CV
        const CV_MARKER = "--- CONTENU CV (Restructur√© par IA) ---";

        // --- GESTION UPLOAD CV (PDF) - AVEC NETTOYAGE IA ---
        async function handleCvUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert("Veuillez s√©lectionner un fichier PDF valide.");
                return;
            }

            const loadingDiv = document.getElementById('cvLoading');
            const textarea = document.getElementById('pastJobs');
            const loadingText = loadingDiv.querySelector('span');
            
            loadingDiv.classList.remove('hidden');
            loadingText.textContent = "Extraction du texte...";
            textarea.disabled = true;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const typedarray = new Uint8Array(arrayBuffer);
                const loadingTask = pdfjsLib.getDocument(typedarray);
                
                loadingTask.onPassword = function (updatePassword, reason) {
                    const password = prompt(reason === 1 ? 'Ce PDF est prot√©g√© par mot de passe. Entrez le mot de passe :' : 'Mot de passe incorrect.');
                    updatePassword(password);
                };

                const pdf = await loadingTask.promise;
                let fullText = "";
                let hasText = false;

                // 1. Extraction technique
                for (let i = 1; i <= pdf.numPages; i++) {
                    loadingText.textContent = `Lecture page ${i}/${pdf.numPages}...`;
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items
                        .map(item => item.str)
                        .filter(str => str.trim().length > 0)
                        .join(' ');
                    
                    if (pageText.length > 50) hasText = true;
                    fullText += pageText + "\n\n";
                }

                if (!hasText) throw new Error("EMPTY_OR_SCANNED_PDF");

                // 2. Nettoyage par IA
                loadingText.textContent = "IA : Restructuration et nettoyage du CV...";
                
                // Appel √† une fonction d√©di√©e qui utilise l'API pour reformater
                let finalText = "";
                try {
                    finalText = await cleanCvWithAI(fullText);
                } catch (aiError) {
                    console.warn("√âchec nettoyage IA, utilisation texte brut", aiError);
                    finalText = fullText; // Fallback
                }

                // 3. Mise √† jour de l'interface
                const currentVal = textarea.value.trim();
                // On garde ce que l'utilisateur avait peut-√™tre d√©j√† tap√© avant l'import
                const cleanVal = currentVal.split(CV_MARKER)[0].trim();
                textarea.value = (cleanVal ? cleanVal + "\n\n" : "") + CV_MARKER + "\n\n" + finalText;
                
                textarea.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => textarea.classList.remove('ring-2', 'ring-green-500'), 1000);

            } catch (error) {
                console.error("Erreur PDF:", error);
                let msg = "Impossible de lire ce fichier PDF.";
                if (error.message === "EMPTY_OR_SCANNED_PDF") msg = "Ce PDF semble √™tre une image (scan) et ne contient pas de texte lisible.";
                alert(msg);
            } finally {
                loadingDiv.classList.add('hidden');
                textarea.disabled = false;
                input.value = ''; 
                checkCvStatus();
            }
        }

        // Nouvelle fonction pour nettoyer le texte brut du CV via l'API
        async function cleanCvWithAI(rawText) {
            // On tronque le texte brut s'il est trop long pour l'appel API de nettoyage
            const safeRawText = rawText.substring(0, 12000);
            
            const prompt = `
            Tu es un assistant administratif. Voici le texte brut extrait d'un fichier PDF de CV, qui est probablement d√©sordonn√© (sauts de ligne, headers m√©lang√©s) :
            
            """
            ${safeRawText}
            """
            
            TACHE : R√©√©cris ce contenu proprement pour qu'il soit lisible dans un champ texte simple.
            1. Identifie et liste les exp√©riences professionnelles (Poste, Entreprise, Dates, Missions).
            2. Identifie les formations principales.
            3. Supprime le texte inutile (num√©ros de page, mentions l√©gales, bas de page).
            4. Utilise un formatage simple avec des tirets (-). Pas de Markdown complexe (pas de gras, pas d'italique).
            
            R√©ponds uniquement avec le texte nettoy√©.
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("Erreur API Nettoyage");
            
            const data = await response.json();
            const cleaned = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!cleaned) throw new Error("R√©ponse IA vide");
            
            return cleaned.trim();
        }

        function checkCvStatus() {
            const content = document.getElementById('pastJobs').value;
            const btnCv = document.getElementById('btnCvAdvice');
            const cvBadge = document.getElementById('cvBadge');
            
            // On v√©rifie la pr√©sence du marqueur (ou d'un texte significatif si le marqueur a √©t√© effac√©)
            if (content.includes("CONTENU CV") || content.length > 50) {
                btnCv.disabled = false;
                btnCv.classList.remove('bg-gray-100', 'text-gray-400');
                btnCv.classList.add('bg-indigo-50', 'text-indigo-600');
                cvBadge.style.display = 'none';
                btnCv.innerHTML = `Am√©liorer mon CV <span class="ml-2 text-green-600">‚úî CV d√©tect√©</span>`;
            } else {
                btnCv.disabled = true;
                cvBadge.style.display = 'block';
                btnCv.innerHTML = `Am√©liorer mon CV <span id="cvBadge" class="block text-xs font-normal mt-1">(N√©cessite l'import d'un CV)</span>`;
            }
        }


        // --- LOGIQUE ANALYSE PRINCIPALE ---
        const SYSTEM_PROMPT = `
        Tu es un expert en orientation professionnelle chez France Travail. 
        Ta mission : Analyser le parcours d'un candidat pour identifier ses comp√©tences transf√©rables vers un m√©tier cible et sugg√©rer des pistes de formation.
        
        Format de r√©ponse attendu (JSON uniquement) :
        {
            "targetJobTitle": "Titre du m√©tier vis√©",
            "analysisSummary": "Une phrase de synth√®se encourageante sur la faisabilit√©.",
            "savoirFaireTechniques": ["Comp√©tence 1", "Comp√©tence 2"],
            "savoirEtreTransferables": ["Qualit√© 1", "Qualit√© 2"],
            "skillsGap": ["Comp√©tence manquante 1", "Comp√©tence manquante 2"],
            "besoinsFormation": ["Suggestion de formation ou certification 1", "Suggestion 2"]
        }
        Ne mets pas de texte avant ou apr√®s le JSON.
        `;

        async function startAnalysis() {
            const btn = document.getElementById('analyzeButton');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const errorMsg = document.getElementById('errorMessage');
            const resultsArea = document.getElementById('resultsArea');
            const furtherActions = document.getElementById('furtherActions');
            const targetJob = document.getElementById('targetJob').value.trim();
            const pastJobs = document.getElementById('pastJobs').value.trim();

            errorMsg.classList.add('hidden');
            resultsArea.classList.add('hidden');
            furtherActions.classList.add('hidden'); 
            document.getElementById('extraContentArea').classList.add('hidden');
            resultsArea.innerHTML = '';

            if (!targetJob || !pastJobs) {
                errorMsg.textContent = "‚ö†Ô∏è Veuillez remplir le m√©tier vis√© ET les exp√©riences pass√©es.";
                errorMsg.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btnText.textContent = "Analyse en cours...";
            btnSpinner.classList.remove('hidden');

            try {
                const safePastJobs = pastJobs.substring(0, 15000); 
                const userQuery = `M√©tier vis√©: ${targetJob}. Exp√©riences: ${safePastJobs}.`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Erreur serveur (${response.status})`);

                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!rawText) throw new Error("Aucune r√©ponse g√©n√©r√©e par l'IA.");

                let cleanJson = rawText.trim();
                const firstBrace = cleanJson.indexOf('{');
                const lastBrace = cleanJson.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    cleanJson = cleanJson.substring(firstBrace, lastBrace + 1);
                }

                const resultObj = JSON.parse(cleanJson);
                displayResults(resultObj);
                
                furtherActions.classList.remove('hidden');
                checkCvStatus();

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "Une erreur est survenue : " + err.message + ". Veuillez r√©essayer.";
                errorMsg.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btnText.textContent = "Lancer l'Analyse des Comp√©tences";
                btnSpinner.classList.add('hidden');
            }
        }

        function displayResults(data) {
            const resultsArea = document.getElementById('resultsArea');
            
            const makeList = (items, colorClass) => {
                if(!items || items.length === 0) return '<p class="text-sm text-gray-500 italic">Non sp√©cifi√©</p>';
                return `<ul class="space-y-2 mt-2">
                    ${items.map(item => `
                        <li class="flex items-start">
                            <span class="mr-2 mt-1.5 w-2 h-2 rounded-full ${colorClass} flex-shrink-0"></span>
                            <span class="text-gray-700">${item}</span>
                        </li>
                    `).join('')}
                </ul>`;
            };

            // Ajout des attributs onclick pour le zoom
            resultsArea.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden">
                    <div class="bg-blue-600 p-4 text-white">
                        <h2 class="text-xl font-bold">R√©sultat pour : ${data.targetJobTitle}</h2>
                        <p class="text-blue-100 text-sm mt-1 opacity-90">${data.analysisSummary}</p>
                        <p class="text-xs text-blue-200 mt-2 italic text-center">üëá Cliquez sur les cadres ci-dessous pour voir plus de d√©tails üëá</p>
                    </div>
                    
                    <div class="p-6 grid gap-6 md:grid-cols-2">
                        <!-- Savoir-Faire (Cliquable) -->
                        <div onclick="zoomDetails('savoir_faire')" class="group cursor-pointer bg-blue-50 p-4 rounded-lg border border-blue-100 hover:shadow-lg hover:border-blue-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-blue-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-blue-800 flex items-center mb-3">
                                üõ†Ô∏è Savoir-Faire (Hard Skills)
                            </h3>
                            ${makeList(data.savoirFaireTechniques, 'bg-blue-500')}
                            <p class="text-xs text-blue-400 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour le d√©tail technique</p>
                        </div>

                        <!-- Savoir-√ätre (Cliquable) -->
                        <div onclick="zoomDetails('savoir_etre')" class="group cursor-pointer bg-green-50 p-4 rounded-lg border border-green-100 hover:shadow-lg hover:border-green-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-green-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-green-800 flex items-center mb-3">
                                ü§ù Savoir-√ätre (Soft Skills)
                            </h3>
                            ${makeList(data.savoirEtreTransferables, 'bg-green-500')}
                            <p class="text-xs text-green-500 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour voir des exemples</p>
                        </div>

                        <!-- Ecarts (Cliquable) -->
                        <div onclick="zoomDetails('gaps')" class="group cursor-pointer bg-orange-50 p-4 rounded-lg border border-orange-100 hover:shadow-lg hover:border-orange-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-orange-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-orange-800 flex items-center mb-3">
                                üöÄ √Ä D√©velopper (Gaps)
                            </h3>
                            ${makeList(data.skillsGap, 'bg-orange-500')}
                            <p class="text-xs text-orange-500 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour analyser les √©carts</p>
                        </div>

                        <!-- Besoins de Formation (Cliquable) -->
                        <div onclick="zoomDetails('formation')" class="group cursor-pointer bg-purple-50 p-4 rounded-lg border border-purple-100 hover:shadow-lg hover:border-purple-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-purple-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-purple-800 flex items-center mb-3">
                                üéì Besoins de Formation
                            </h3>
                            ${makeList(data.besoinsFormation, 'bg-purple-500')}
                            <p class="text-xs text-purple-500 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour voir les titres RNCP</p>
                        </div>
                    </div>
                     <div class="p-4 bg-gray-50 text-center text-xs text-gray-500 border-t">
                        Document g√©n√©r√© par l'assistant IA France Travail
                    </div>
                </div>
            `;
            
            resultsArea.classList.remove('hidden');
            resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- GESTION DU ZOOM (MODALE) ---
        function closeZoom() {
            document.getElementById('zoomModal').classList.add('hidden');
        }

        async function zoomDetails(category) {
            const modal = document.getElementById('zoomModal');
            const spinner = document.getElementById('zoomSpinner');
            const content = document.getElementById('zoomContent');
            const headerTitle = document.getElementById('modal-title');
            const zoomHeader = document.getElementById('zoomHeader');
            
            const targetJob = document.getElementById('targetJob').value.trim();
            const pastJobs = document.getElementById('pastJobs').value.trim();

            modal.classList.remove('hidden');
            spinner.classList.remove('hidden');
            content.classList.add('hidden');
            
            let prompt = "";
            let titleText = "";
            let headerColor = "";

            // Configuration selon la cat√©gorie
            switch(category) {
                case 'savoir_faire':
                    titleText = "üõ†Ô∏è Analyse d√©taill√©e : Savoir-Faire Techniques";
                    headerColor = "bg-blue-50";
                    prompt = `Tu es un expert m√©tier pour le poste de : ${targetJob}.
                    Exp√©riences du candidat : ${pastJobs.substring(0, 5000)}.
                    Le candidat a besoin de d√©tails sur les COMP√âTENCES TECHNIQUES (Hard Skills).
                    1. Liste les outils, logiciels, machines ou protocoles pr√©cis qu'il ma√Ætrise probablement d√©j√†.
                    2. Liste ceux qu'il DOIT ma√Ætriser pour le poste cible (en expliquant pourquoi).
                    Sois tr√®s pr√©cis (noms de logiciels, normes ISO, types de machines).
                    R√©ponds en HTML simple (<h3>, <ul>, <li>, <strong>).`;
                    break;
                case 'savoir_etre':
                    titleText = "ü§ù Analyse d√©taill√©e : Savoir-√ätre (Soft Skills)";
                    headerColor = "bg-green-50";
                    prompt = `Tu es coach RH. Poste vis√© : ${targetJob}.
                    D√©taille les SAVOIR-√äTRE (Soft Skills) requis.
                    Pour chaque qualit√©, donne un exemple concret de situation professionnelle o√π elle s'applique dans ce m√©tier sp√©cifique.
                    R√©ponds en HTML simple.`;
                    break;
                case 'gaps':
                    titleText = "üöÄ Analyse d√©taill√©e : √âcarts √† combler";
                    headerColor = "bg-orange-50";
                    prompt = `Tu es conseiller en √©volution. Poste vis√© : ${targetJob}.
                    Exp√©riences : ${pastJobs.substring(0, 5000)}.
                    Analyse les √âCARTS (Gaps) entre le profil actuel et le poste.
                    Pour chaque manque identifi√©, explique s'il est critique (bloquant pour l'embauche) ou s'il peut s'apprendre sur le tas.
                    R√©ponds en HTML simple.`;
                    break;
                case 'formation':
                    titleText = "üéì Analyse d√©taill√©e : Plan de Formation";
                    headerColor = "bg-purple-50";
                    prompt = `Tu es expert en formation France Travail. Poste vis√© : ${targetJob}.
                    Sugg√®re des formations pr√©cises pour combler les manques.
                    IMPORTANT : Donne des exemples de Titres Professionnels (TP) ou dipl√¥mes avec leur code RNCP si possible, et une estimation de dur√©e (ex: 400h).
                    Mentionne les dispositifs potentiels (CPF, POE, Alternance, financement region).
                    R√©ponds en HTML simple.`;
                    break;
            }

            headerTitle.textContent = titleText;
            zoomHeader.className = `px-6 py-4 border-b border-gray-200 flex justify-between items-center ${headerColor}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                let cleanHtml = rawText.replace(/```html/g, '').replace(/```/g, '');

                content.innerHTML = cleanHtml;
                spinner.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                content.innerHTML = `<p class="text-red-600 font-bold">Erreur lors de la r√©cup√©ration des d√©tails. Veuillez v√©rifier votre connexion et r√©essayer.</p>`;
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }

        // --- FONCTIONS EXISTANTES "POUR ALLER PLUS LOIN" ---
        async function getAdvice(type) {
            const extraArea = document.getElementById('extraContentArea');
            const extraText = document.getElementById('extraContentText');
            const extraSpinner = document.getElementById('extraContentSpinner');
            const targetJob = document.getElementById('targetJob').value.trim();
            const pastJobs = document.getElementById('pastJobs').value.trim();

            extraArea.classList.remove('hidden');
            extraText.innerHTML = '';
            extraSpinner.classList.remove('hidden');
            extraArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            let prompt = "";
            let title = "";
            let color = "";

            if (type === 'cv') {
                title = "üìå Propositions d'am√©lioration pour le CV";
                color = "text-indigo-800";
                prompt = `Expert RH. Profil : ${pastJobs.substring(0, 5000)}. Poste : ${targetJob}.
                Donne 3 √† 5 recommandations concr√®tes pour le CV (mots-cl√©s, structure). HTML simple.`;
            } else {
                title = "üéôÔ∏è Arguments cl√©s pour l'entretien";
                color = "text-teal-800";
                prompt = `Coach recrutement. Poste : ${targetJob}. Profil : ${pastJobs.substring(0, 5000)}.
                3 √† 5 punchlines/arguments pour l'entretien. HTML simple.`;
            }

            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const cleanHtml = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```html/g, '').replace(/```/g, '');

                extraText.innerHTML = `
                    <h4 class="text-xl font-bold ${color} mb-4 border-b pb-2">${title}</h4>
                    <div class="space-y-4 text-gray-700 leading-relaxed">${cleanHtml}</div>
                `;
            } catch (e) {
                extraText.innerHTML = `<p class="text-red-600">Erreur.</p>`;
            } finally {
                extraSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
