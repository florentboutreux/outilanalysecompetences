<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartographie des Comp√©tences - France Travail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, marianne; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-enter { animation: modalSlideIn 0.3s ease-out forwards; }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Style pour le markdown simplifi√© g√©n√©r√© */
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.5em; }
        .prose h3 { font-weight: 700; font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; }
        .prose strong { color: #1e3a8a; }
        
        /* Indicateur discret de la cl√© API */
        #apiStatusIndicator { transition: all 0.3s ease; }
        #apiStatusIndicator.active { color: #16a34a; background-color: #dcfce7; border-color: #bbf7d0; }
        #apiStatusIndicator.inactive { color: #ca8a04; background-color: #fef9c3; border-color: #fde047; }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800 relative min-h-screen">

    <!-- Bouton Config API (Cach√© si cl√© hardcod√©e pr√©sente) -->
    <div id="configButtonContainer" class="absolute top-4 right-4 z-40 hidden">
        <button onclick="openApiKeyModal()" id="apiStatusIndicator" class="inactive flex items-center gap-2 px-3 py-2 rounded-full shadow-sm border text-xs font-medium transition cursor-pointer">
            <svg id="keyIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
            <span id="apiStatusText">Cl√© manquante</span>
        </button>
    </div>

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10 pt-4">
            <div class="inline-block p-3 rounded-full bg-blue-100 mb-4">
                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900 mb-2">Cartographie des Comp√©tences</h1>
            <p class="text-lg text-blue-600">Assistant d'analyse & Formation</p>
        </header>

        <!-- Avertissement si pas de cl√© API -->
        <div id="apiWarning" class="hidden max-w-2xl mx-auto mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 text-yellow-800 shadow-sm rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm">
                        <span class="font-bold">Configuration requise.</span> 
                        Pour que l'outil fonctionne, une cl√© API est n√©cessaire.
                        <button onclick="openApiKeyModal()" class="underline font-semibold hover:text-yellow-900 ml-1">Configurer maintenant</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Formulaire de Saisie -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl border border-blue-100 mb-8">
            <div class="space-y-6">
                <!-- M√©tier Recherch√© -->
                <div>
                    <label for="targetJob" class="block text-lg font-semibold text-gray-700 mb-2">
                        1. M√©tier vis√© 
                    </label>
                    <textarea id="targetJob" rows="1" placeholder="Ex: Assistant Administratif, Plombier, D√©veloppeur..."
                        class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-inner resize-none"></textarea>
                </div>

                <!-- M√©tiers Ant√©rieurs (Saisie seule) -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label for="pastJobs" class="block text-lg font-semibold text-gray-700">
                            2. Exp√©riences pass√©es
                        </label>
                    </div>
                    
                    <textarea id="pastJobs" rows="8" oninput="checkInputStatus()" placeholder="Copiez-collez ici vos exp√©riences professionnelles, vos dipl√¥mes ou le contenu de votre CV..."
                        class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-inner resize-none"></textarea>
                </div>

                <!-- Bouton d'Analyse -->
                <div class="text-center pt-2">
                    <button id="analyzeButton" onclick="startAnalysis()"
                        class="w-full md:w-2/3 py-4 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-blue-700 active:bg-blue-800 transition transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center mx-auto">
                        <span id="btnText">Lancer l'Analyse des Comp√©tences</span>
                        <svg id="btnSpinner" class="hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p id="errorMessage" class="hidden mt-4 text-red-600 font-medium bg-red-50 p-3 rounded-lg border border-red-200"></p>
                </div>
            </div>
        </div>

        <!-- Zone de R√©sultats -->
        <div id="resultsArea" class="hidden fade-in">
            <!-- Les r√©sultats seront inject√©s ici par JS -->
        </div>

        <!-- Section "Pour aller plus loin" -->
        <div id="furtherActions" class="hidden max-w-5xl mx-auto mt-8 mb-12 fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-600 w-8 h-8 rounded-full text-white flex items-center justify-center text-sm mr-3">3</span>
                Pour aller plus loin
            </h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Bouton Suggestions CV -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-indigo-100 flex flex-col">
                    <h4 class="font-bold text-lg text-indigo-900 mb-2">Optimisation du CV</h4>
                    <p class="text-gray-600 text-sm mb-4 flex-grow">Obtenez des suggestions concr√®tes pour adapter votre texte actuel au poste vis√©.</p>
                    <button id="btnCvAdvice" onclick="getAdvice('cv')" disabled
                        class="w-full py-3 bg-indigo-50 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-100 transition border border-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400">
                        Am√©liorer mon CV
                    </button>
                </div>

                <!-- Bouton Arguments Entretien -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-teal-100 flex flex-col">
                    <h4 class="font-bold text-lg text-teal-900 mb-2">Pr√©paration √† l'entretien</h4>
                    <p class="text-gray-600 text-sm mb-4 flex-grow">G√©n√©rez les arguments cl√©s pour convaincre le recruteur.</p>
                    <button onclick="getAdvice('interview')"
                        class="w-full py-3 bg-teal-50 text-teal-600 font-semibold rounded-lg hover:bg-teal-100 transition border border-teal-200">
                        G√©n√©rer mes Arguments
                    </button>
                </div>
            </div>

            <!-- Zone d'affichage des conseils suppl√©mentaires -->
            <div id="extraContentArea" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                <div id="extraContentSpinner" class="hidden flex justify-center py-4">
                    <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
                <div id="extraContentText" class="prose max-w-none text-gray-700"></div>
            </div>
        </div>

    </div>

    <!-- MODALE DE ZOOM (DETAIL) -->
    <div id="zoomModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeZoom()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="relative inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full modal-enter">
                <div id="zoomHeader" class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-900" id="modal-title">D√©tails</h3>
                    <button type="button" onclick="closeZoom()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    <div id="zoomSpinner" class="flex flex-col items-center justify-center py-10">
                        <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="text-gray-500">G√©n√©ration des d√©tails approfondis en cours...</p>
                    </div>
                    <div id="zoomContent" class="prose max-w-none text-gray-700 hidden"></div>
                </div>
                <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeZoom()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE API KEY -->
    <div id="apiKeyModal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeApiKeyModal()"></div>
            <div class="relative bg-white rounded-lg max-w-md w-full p-6 shadow-xl">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Configuration API</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Pour que cet outil fonctionne en ligne, il a besoin d'une cl√© API Gemini.
                    <br><br>
                    <strong>Option 1 (Utilisateur) :</strong> Entrez une cl√© ci-dessous. Elle sera sauvegard√©e dans votre navigateur uniquement.
                    <br>
                    <strong>Option 2 (D√©veloppeur) :</strong> Pour ne pas demander cela √† vos utilisateurs, √©ditez le fichier <code>index.html</code> et collez votre cl√© dans la variable <code>HARDCODED_API_KEY</code>.
                </p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cl√© API</label>
                    <input type="password" id="apiKeyInput" placeholder="Collez votre cl√© ici..." 
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeApiKeyModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Fermer</button>
                    <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Logique -->
    <script>
        // =================================================================
        // ZONE DE CONFIGURATION (POUR D√âPLOIEMENT EN LIGNE)
        // =================================================================
        // Si vous voulez que l'outil fonctionne sans que l'utilisateur n'ait 
        // √† entrer de cl√©, collez VOTRE cl√© API Gemini entre les guillemets ci-dessous.
        // ATTENTION : Cette cl√© sera visible dans le code source (HTML). 
        // Il est recommand√© de restreindre cette cl√© √† votre domaine (HTTP Referrer) 
        // depuis la console Google Cloud pour √©viter les abus.
        
        const HARDCODED_API_KEY = "AIzaSyBK07GzjD9YdK-W2Xc13Ue7kfKY1YLpMlM"; 
        
        // =================================================================


        // --- GESTION HYBRIDE DE LA CL√â API ---
        
        // Cl√© syst√®me (inject√©e par l'environnement de chat - ne pas toucher)
        const SYSTEM_API_KEY = ""; 
        
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';

        // Fonction pour r√©cup√©rer la cl√© valide (Priorit√© : Syst√®me > Hardcod√©e > Utilisateur)
        function getEffectiveApiKey() {
            // 1. Cl√© syst√®me (Preview Canvas)
            if (SYSTEM_API_KEY && SYSTEM_API_KEY.length > 0 && SYSTEM_API_KEY !== '""') return SYSTEM_API_KEY;
            
            // 2. Cl√© hardcod√©e par le d√©veloppeur (Pour le site en ligne)
            if (HARDCODED_API_KEY && HARDCODED_API_KEY.length > 0) return HARDCODED_API_KEY;

            // 3. Cl√© entr√©e par l'utilisateur (LocalStorage)
            return localStorage.getItem('gemini_api_key') || "";
        }

        function getApiUrl() {
            return `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${getEffectiveApiKey()}`;
        }
        
        // Initialisation de l'√©tat
        document.addEventListener('DOMContentLoaded', () => {
            updateApiStatusUI();
            checkInputStatus(); // Check initial au cas o√π le navigateur remplit le champ
        });

        function updateApiStatusUI() {
            const key = getEffectiveApiKey();
            const btnContainer = document.getElementById('configButtonContainer');
            const indicator = document.getElementById('apiStatusIndicator');
            const statusText = document.getElementById('apiStatusText');
            const warningBox = document.getElementById('apiWarning');

            // Si une cl√© est hardcod√©e ou syst√®me, on cache le bouton de config pour l'utilisateur final
            // car tout fonctionne de mani√®re transparente pour lui.
            if ((HARDCODED_API_KEY && HARDCODED_API_KEY.length > 0) || (SYSTEM_API_KEY && SYSTEM_API_KEY.length > 0)) {
                btnContainer.classList.add('hidden');
                warningBox.classList.add('hidden');
                return;
            }

            // Sinon (mode BYOK - Bring Your Own Key), on affiche le bouton
            btnContainer.classList.remove('hidden');

            if (key) {
                indicator.classList.remove('inactive');
                indicator.classList.add('active');
                statusText.textContent = "API Connect√©e";
                warningBox.classList.add('hidden');
            } else {
                indicator.classList.remove('active');
                indicator.classList.add('inactive');
                statusText.textContent = "Cl√© manquante";
                warningBox.classList.remove('hidden');
            }
        }

        // --- GESTION MODALE API ---
        function openApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || "";
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        function saveApiKey() {
            const val = document.getElementById('apiKeyInput').value.trim();
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                updateApiStatusUI();
                closeApiKeyModal();
            } else {
                localStorage.removeItem('gemini_api_key');
                updateApiStatusUI();
                closeApiKeyModal();
            }
        }

        // Activation du bouton d'aide CV selon le contenu
        function checkInputStatus() {
            const content = document.getElementById('pastJobs').value;
            const btnCv = document.getElementById('btnCvAdvice');
            
            // On active si l'utilisateur a tap√© un minimum de texte (ex: 50 caract√®res)
            if (content.length > 50) {
                btnCv.disabled = false;
                btnCv.classList.remove('bg-gray-100', 'text-gray-400');
                btnCv.classList.add('bg-indigo-50', 'text-indigo-600');
            } else {
                btnCv.disabled = true;
                btnCv.classList.add('bg-gray-100', 'text-gray-400');
                btnCv.classList.remove('bg-indigo-50', 'text-indigo-600');
            }
        }

        // --- LOGIQUE ANALYSE PRINCIPALE ---
        const SYSTEM_PROMPT = `
        Tu es un expert en orientation professionnelle chez France Travail. 
        Ta mission : Analyser le parcours d'un candidat pour identifier ses comp√©tences transf√©rables vers un m√©tier cible et sugg√©rer des pistes de formation.
        
        Format de r√©ponse attendu (JSON uniquement) :
        {
            "targetJobTitle": "Titre du m√©tier vis√©",
            "analysisSummary": "Une phrase de synth√®se encourageante sur la faisabilit√©.",
            "savoirFaireTechniques": ["Comp√©tence 1", "Comp√©tence 2"],
            "savoirEtreTransferables": ["Qualit√© 1", "Qualit√© 2"],
            "skillsGap": ["Comp√©tence manquante 1", "Comp√©tence manquante 2"],
            "besoinsFormation": ["Suggestion de formation ou certification 1", "Suggestion 2"]
        }
        Ne mets pas de texte avant ou apr√®s le JSON. Pas de Markdown.
        `;

        async function startAnalysis() {
            if (!getEffectiveApiKey()) {
                openApiKeyModal();
                return;
            }

            const btn = document.getElementById('analyzeButton');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const errorMsg = document.getElementById('errorMessage');
            const resultsArea = document.getElementById('resultsArea');
            const furtherActions = document.getElementById('furtherActions');
            const targetJob = document.getElementById('targetJob').value.trim();
            const pastJobs = document.getElementById('pastJobs').value.trim();

            errorMsg.classList.add('hidden');
            resultsArea.classList.add('hidden');
            furtherActions.classList.add('hidden'); 
            document.getElementById('extraContentArea').classList.add('hidden');
            resultsArea.innerHTML = '';

            if (!targetJob || !pastJobs) {
                errorMsg.textContent = "‚ö†Ô∏è Veuillez remplir le m√©tier vis√© ET les exp√©riences pass√©es.";
                errorMsg.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btnText.textContent = "Analyse en cours...";
            btnSpinner.classList.remove('hidden');

            try {
                const safePastJobs = pastJobs.substring(0, 15000); 
                const userQuery = `M√©tier vis√©: ${targetJob}. Exp√©riences: ${safePastJobs}.`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                    // Force le format JSON pour √©viter les erreurs de parsing
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Erreur API (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!rawText) throw new Error("Aucune r√©ponse g√©n√©r√©e par l'IA.");

                // Parsing Robuste (Nettoyage des balises Markdown ```json ... ```)
                let cleanJson = rawText.trim();
                cleanJson = cleanJson.replace(/^```json\s*/g, '').replace(/^```\s*/g, '').replace(/\s*```$/g, '');

                const resultObj = JSON.parse(cleanJson);
                displayResults(resultObj);
                
                furtherActions.classList.remove('hidden');
                checkInputStatus();

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "Une erreur est survenue : " + err.message + ". V√©rifiez votre cl√© API.";
                errorMsg.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btnText.textContent = "Lancer l'Analyse des Comp√©tences";
                btnSpinner.classList.add('hidden');
            }
        }

        function displayResults(data) {
            const resultsArea = document.getElementById('resultsArea');
            
            const makeList = (items, colorClass) => {
                if(!items || items.length === 0) return '<p class="text-sm text-gray-500 italic">Non sp√©cifi√©</p>';
                return `<ul class="space-y-2 mt-2">
                    ${items.map(item => `
                        <li class="flex items-start">
                            <span class="mr-2 mt-1.5 w-2 h-2 rounded-full ${colorClass} flex-shrink-0"></span>
                            <span class="text-gray-700">${item}</span>
                        </li>
                    `).join('')}
                </ul>`;
            };

            resultsArea.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden">
                    <div class="bg-blue-600 p-4 text-white">
                        <h2 class="text-xl font-bold">R√©sultat pour : ${data.targetJobTitle}</h2>
                        <p class="text-blue-100 text-sm mt-1 opacity-90">${data.analysisSummary}</p>
                        <p class="text-xs text-blue-200 mt-2 italic text-center">üëá Cliquez sur les cadres ci-dessous pour voir plus de d√©tails üëá</p>
                    </div>
                    
                    <div class="p-6 grid gap-6 md:grid-cols-2">
                        <!-- Savoir-Faire (Cliquable) -->
                        <div onclick="zoomDetails('savoir_faire')" class="group cursor-pointer bg-blue-50 p-4 rounded-lg border border-blue-100 hover:shadow-lg hover:border-blue-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-blue-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-blue-800 flex items-center mb-3">
                                Savoir-Faire (Hard Skills)
                            </h3>
                            ${makeList(data.savoirFaireTechniques, 'bg-blue-500')}
                            <p class="text-xs text-blue-400 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour le d√©tail technique</p>
                        </div>

                        <!-- Savoir-√ätre (Cliquable) -->
                        <div onclick="zoomDetails('savoir_etre')" class="group cursor-pointer bg-green-50 p-4 rounded-lg border border-green-100 hover:shadow-lg hover:border-green-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-green-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-green-800 flex items-center mb-3">
                                Savoir-√ätre (Soft Skills)
                            </h3>
                            ${makeList(data.savoirEtreTransferables, 'bg-green-500')}
                            <p class="text-xs text-green-500 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour voir des exemples</p>
                        </div>

                        <!-- Ecarts (Cliquable) -->
                        <div onclick="zoomDetails('gaps')" class="group cursor-pointer bg-orange-50 p-4 rounded-lg border border-orange-100 hover:shadow-lg hover:border-orange-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-orange-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-orange-800 flex items-center mb-3">
                                √Ä D√©velopper 
                            </h3>
                            ${makeList(data.skillsGap, 'bg-orange-500')}
                            <p class="text-xs text-orange-500 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour analyser les √©carts</p>
                        </div>

                        <!-- Besoins de Formation (Cliquable) -->
                        <div onclick="zoomDetails('formation')" class="group cursor-pointer bg-purple-50 p-4 rounded-lg border border-purple-100 hover:shadow-lg hover:border-purple-300 transition-all transform hover:-translate-y-1 relative">
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-purple-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            </div>
                            <h3 class="font-bold text-purple-800 flex items-center mb-3">
                                Besoins de Formation
                            </h3>
                            ${makeList(data.besoinsFormation, 'bg-purple-500')}
                            <p class="text-xs text-purple-500 mt-3 text-center opacity-0 group-hover:opacity-100 transition-opacity font-semibold">Cliquez pour voir les titres RNCP</p>
                        </div>
                    </div>
                     <div class="p-4 bg-gray-50 text-center text-xs text-gray-500 border-t">
                        Document g√©n√©r√© par l'assistant IA France Travail (POC)
                    </div>
                </div>
            `;
            
            resultsArea.classList.remove('hidden');
            resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- GESTION DU ZOOM (MODALE) ---
        function closeZoom() {
            document.getElementById('zoomModal').classList.add('hidden');
        }

        async function zoomDetails(category) {
            const modal = document.getElementById('zoomModal');
            const spinner = document.getElementById('zoomSpinner');
            const content = document.getElementById('zoomContent');
            const headerTitle = document.getElementById('modal-title');
            const zoomHeader = document.getElementById('zoomHeader');
            
            const targetJob = document.getElementById('targetJob').value.trim();
            const pastJobs = document.getElementById('pastJobs').value.trim();

            if (!getEffectiveApiKey()) { openApiKeyModal(); return; }

            modal.classList.remove('hidden');
            spinner.classList.remove('hidden');
            content.classList.add('hidden');
            
            let prompt = "";
            let titleText = "";
            let headerColor = "";

            switch(category) {
                case 'savoir_faire':
                    titleText = "Analyse d√©taill√©e : Savoir-Faire Techniques";
                    headerColor = "bg-blue-50";
                    prompt = `Tu es un expert m√©tier pour le poste de : ${targetJob}.
                    Exp√©riences du candidat : ${pastJobs.substring(0, 5000)}.
                    Le candidat a besoin de d√©tails sur les COMP√âTENCES TECHNIQUES (Hard Skills).
                    1. Liste les outils, logiciels, machines ou protocoles pr√©cis qu'il ma√Ætrise probablement d√©j√†.
                    2. Liste ceux qu'il DOIT ma√Ætriser pour le poste cible (en expliquant pourquoi).
                    Sois tr√®s pr√©cis (noms de logiciels, normes ISO, types de machines).
                    R√©ponds en HTML simple (<h3>, <ul>, <li>, <strong>).`;
                    break;
                case 'savoir_etre':
                    titleText = "Analyse d√©taill√©e : Savoir-√ätre (Soft Skills)";
                    headerColor = "bg-green-50";
                    prompt = `Tu es coach RH. Poste vis√© : ${targetJob}.
                    D√©taille les SAVOIR-√äTRE (Soft Skills) requis.
                    Pour chaque qualit√©, donne un exemple concret de situation professionnelle o√π elle s'applique dans ce m√©tier sp√©cifique.
                    R√©ponds en HTML simple.`;
                    break;
                case 'gaps':
                    titleText = "Analyse d√©taill√©e : √âcarts √† combler";
                    headerColor = "bg-orange-50";
                    prompt = `Tu es conseiller en √©volution. Poste vis√© : ${targetJob}.
                    Exp√©riences : ${pastJobs.substring(0, 5000)}.
                    Analyse les √âCARTS (Gaps) entre le profil actuel et le poste.
                    Pour chaque manque identifi√©, explique s'il est critique (bloquant pour l'embauche) ou s'il peut s'apprendre sur le tas.
                    R√©ponds en HTML simple.`;
                    break;
                case 'formation':
                    titleText = "Analyse d√©taill√©e : Plan de Formation";
                    headerColor = "bg-purple-50";
                    prompt = `Tu es expert en formation France Travail. Poste vis√© : ${targetJob}.
                    Sugg√®re des formations pr√©cises pour combler les manques.
                    IMPORTANT : Donne des exemples de Titres Professionnels (TP) ou dipl√¥mes avec leur code RNCP si possible, et une estimation de dur√©e (ex: 400h).
                    Mentionne les dispositifs potentiels (CPF, POE, Alternance, financement region).
                    R√©ponds en HTML simple.`;
                    break;
            }

            headerTitle.textContent = titleText;
            zoomHeader.className = `px-6 py-4 border-b border-gray-200 flex justify-between items-center ${headerColor}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error("Erreur API");

                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                let cleanHtml = rawText.replace(/```html/g, '').replace(/```/g, '');

                content.innerHTML = cleanHtml;
                spinner.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                content.innerHTML = `<p class="text-red-600 font-bold">Erreur lors de la r√©cup√©ration des d√©tails. V√©rifiez votre cl√© API.</p>`;
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }

        // --- FONCTIONS EXISTANTES "POUR ALLER PLUS LOIN" ---
        async function getAdvice(type) {
            if (!getEffectiveApiKey()) { openApiKeyModal(); return; }

            const extraArea = document.getElementById('extraContentArea');
            const extraText = document.getElementById('extraContentText');
            const extraSpinner = document.getElementById('extraContentSpinner');
            const targetJob = document.getElementById('targetJob').value.trim();
            const pastJobs = document.getElementById('pastJobs').value.trim();

            extraArea.classList.remove('hidden');
            extraText.innerHTML = '';
            extraSpinner.classList.remove('hidden');
            extraArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            let prompt = "";
            let title = "";
            let color = "";

            if (type === 'cv') {
                title = "Propositions d'am√©lioration pour le CV";
                color = "text-indigo-800";
                prompt = `Expert RH. Profil : ${pastJobs.substring(0, 5000)}. Poste : ${targetJob}.
                Donne 3 √† 5 recommandations concr√®tes pour le CV (mots-cl√©s, structure). HTML simple.`;
            } else {
                title = "Arguments cl√©s pour l'entretien";
                color = "text-teal-800";
                prompt = `Coach recrutement. Poste : ${targetJob}. Profil : ${pastJobs.substring(0, 5000)}.
                3 √† 5 punchlines/arguments pour l'entretien. HTML simple.`;
            }

            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error("Erreur API");

                const data = await response.json();
                const cleanHtml = data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```html/g, '').replace(/```/g, '');

                extraText.innerHTML = `
                    <h4 class="text-xl font-bold ${color} mb-4 border-b pb-2">${title}</h4>
                    <div class="space-y-4 text-gray-700 leading-relaxed">${cleanHtml}</div>
                `;
            } catch (e) {
                extraText.innerHTML = `<p class="text-red-600">Erreur lors de la g√©n√©ration. V√©rifiez votre cl√© API.</p>`;
            } finally {
                extraSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
